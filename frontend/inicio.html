<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>UniEats - Iniciar sesión</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="estilos.css" />
</head>
<body>
  <div id="app" class="login-wrap">
    <div class="login-card">
      <img src="img/logo.png" alt="Logo UniEats" class="logo" />
      <h1 class="brand">Uni<span class="brand-e">E</span>ats</h1>
      <h2 class="login-title">Iniciar sesión</h2>

      <label for="email">Email</label>
      <input id="email" type="email" v-model="email" placeholder="nombre@ucema.edu.ar" />

      <label for="pass">Contraseña</label>
      <input id="pass" type="password" v-model="pass" placeholder="********" />

      <label for="uni">Universidad</label>
      <select id="uni" v-model="uni">
        <option value="ucema">UCEMA</option>
        <option value="otra">Otra</option>
      </select>

      <button class="btn-primary btn-narrow" @click="iniciar" :disabled="cargando">
        {{ cargando ? 'Creando pedido…' : 'Iniciar sesión' }}
      </button>

      <p v-if="error" class="error" style="margin-top:10px">{{ error }}</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
  new Vue({
    el:'#app',
    data:{ email:'', pass:'', uni:'ucema', cargando:false, error:'' },
    methods:{
      async iniciar(){
        this.error='';
        if(!this.email || this.email.indexOf('@')===-1){ this.error='Ingresá un email válido.'; return; }
        if(!this.pass || !this.pass.trim()){ this.error='Ingresá tu contraseña.'; return; }

        this.cargando = true;
        const base = 'http://127.0.0.1:4000';

        try{
          // 1) Login (backend acepta cualquier password no vacía)
          await axios.post(base + '/login', { username:this.email, password:this.pass });

          // 2) Intentar crear pedido (si falla, igual entramos)
          let pedidoId = null;
          try {
            const r = await axios.post(base + '/api/pedidos', { uni:this.uni });
            pedidoId = r.data && r.data.id ? r.data.id : null;
          } catch(_) { /* sin drama, seguimos */ }

          const qs = 'uni=' + encodeURIComponent(this.uni) + (pedidoId ? '&pedido=' + encodeURIComponent(pedidoId) : '');
          window.location = 'menu.html?' + qs;

        }catch(e){
          this.error = 'No se pudo iniciar sesión. Probá de nuevo.';
        }finally{
          this.cargando = false;
        }
      }
    }
  });
  </script>
</body>
</html>
