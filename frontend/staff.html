<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>UniEats - Staff</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="estilos.css" />
</head>
<body>
  <div id="app" class="page">
    <!-- ================= Productos ================= -->
    <div class="card">
      <h1 class="title">Productos</h1>

      <!-- Formulario Alta/EdiciÃ³n -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:920px">
        <div>
          <label>Nombre</label>
          <input v-model.trim="form.nombre" placeholder="Ej: CafÃ© chico">
        </div>
        <div>
          <label>Precio</label>
          <input v-model.number="form.precio" type="number" min="0" step="1" placeholder="Ej: 1200">
        </div>
        <div>
          <label>CategorÃ­a</label>
          <select v-model="form.categoria">
            <option v-for="c in categorias" :key="c">{{ c }}</option>
          </select>
        </div>
        <div>
          <label>Universidad</label>
          <select v-model="form.uni">
            <option value="ucema">UCEMA</option>
            <option value="generic">Otra</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn-primary" @click="guardar" :disabled="enviandoProd">
          {{ enviandoProd ? 'Guardandoâ€¦' : (form.id ? 'Actualizar' : 'Agregar') }}
        </button>
        <button class="btn-primary" style="background:#6b7280" @click="cancelarEdicion" :disabled="enviandoProd">
          Cancelar
        </button>
      </div>
      <p v-if="errorProd" class="error">{{ errorProd }}</p>

      <!-- Filtros de vista -->
      <div style="display:flex;gap:10px;align-items:center;margin-top:14px">
        <label style="margin:0">Filtrar por:</label>
        <select v-model="filtro.cat" style="max-width:180px">
          <option value="">(todas las categorÃ­as)</option>
          <option v-for="c in categorias" :key="c">{{ c }}</option>
        </select>
        <select v-model="filtro.uni" style="max-width:150px">
          <option value="">(todas las unis)</option>
          <option value="ucema">UCEMA</option>
          <option value="generic">Otra</option>
        </select>
        <input v-model.trim="filtro.q" placeholder="Buscar nombreâ€¦" style="max-width:240px">
        <span style="margin-left:auto;font-weight:700">Total: {{ productosFiltrados.length }}</span>
      </div>

      <!-- Lista de productos -->
      <ul class="list" style="margin-top:10px">
        <li class="item" v-for="p in productosFiltrados" :key="p.id">
          <span>
            <strong>#{{ p.id }}</strong> â€” {{ p.nombre }}
            <small style="opacity:.7">[{{ p.categoria }} Â· {{ p.uni }}]</small>
          </span>
          <span>
            <span class="badge">${{ p.precio }}</span>
            <button class="btn-primary" style="margin-left:8px;padding:8px 10px" @click="editar(p)">Editar</button>
            <button class="btn-primary" style="margin-left:6px;background:#b00020;padding:8px 10px"
                    @click="borrar(p)" :disabled="enviandoProd">Borrar</button>
          </span>
        </li>
      </ul>
    </div>

    <!-- ================= Pedidos (Tablero) ================= -->
    <div class="card">
      <h1 class="title">Pedidos</h1>

      <!-- Filtros -->
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <label style="margin:0">Estado</label>
        <select v-model="filtroPed.estado" style="max-width:180px" @change="cargarPedidos">
          <option value="">(todos)</option>
          <option value="pendiente">pendiente</option>
          <option value="en_preparacion">en_preparacion</option>
          <option value="listo">listo</option>
        </select>
        <label style="margin-left:8px;margin-right:0">Desde hora</label>
        <input v-model="filtroPed.desde" placeholder="HH:MM (opcional)" style="max-width:130px">
        <button class="btn-primary" style="padding:8px 12px" @click="cargarPedidos" :disabled="cargandoPed">
          {{ cargandoPed ? 'Cargandoâ€¦' : 'Actualizar' }}
        </button>
        <span style="margin-left:auto;font-weight:700">Total: {{ pedidos.length }}</span>
      </div>

      <!-- Lista -->
      <ul class="list" style="margin-top:10px">
        <li class="item" v-for="pd in pedidos" :key="pd.id">
          <div style="display:flex;flex-direction:column">
            <strong>Pedido #{{ pd.id }}</strong>
            <small style="opacity:.75">
              uni: {{ pd.uni || 'ucema' }} Â· estado: {{ pd.estado || 'pendiente' }} Â· pago: {{ pd.estado_pago || 'pendiente' }} Â· hora: {{ pd.hora_retiro || '-' }}
            </small>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn-primary" style="padding:8px 10px" @click="setEstado(pd,'en_preparacion')" :disabled="cargandoPed">Preparar</button>
            <button class="btn-primary" style="padding:8px 10px" @click="setEstado(pd,'listo')" :disabled="cargandoPed">Listo</button>
            <button class="btn-primary" style="padding:8px 10px;background:#0f766e" @click="setPago(pd,'confirmado')" :disabled="cargandoPed">Pago OK</button>
          </div>
        </li>
      </ul>
      <p v-if="errorPed" class="error">{{ errorPed }}</p>
    </div>

    <nav class="nav-bottom">
      <a class="nav-item" href="inicio.html"><span class="ico">ðŸ“‹ï¸Ž</span><span>Mis Pedidos</span></a>
      <a class="nav-item" href="#"><span class="ico">ðŸ””ï¸Ž</span><span>Notificaciones</span></a>
      <a class="nav-item" href="#"><span class="ico">ðŸ‘¤ï¸Ž</span><span>Mi Perfil</span></a>
    </nav>
  </div>

  <script>
  const UE_USER = localStorage.getItem('ue_user');
  if (!UE_USER) { window.location = 'inicio.html'; }
</script>

  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    new Vue({
      el:'#app',
      data:{
        base:'http://127.0.0.1:4000',
        /* Productos */
        productos:[],
        form:{ id:'', nombre:'', precio:'', categoria:'comida', uni:'ucema' },
        categorias:['comida','panificado','bebida','promo'],
        filtro:{ cat:'', uni:'', q:'' },
        enviandoProd:false,
        errorProd:'',

        /* Pedidos */
        pedidos:[],
        filtroPed:{ estado:'', desde:'' },
        cargandoPed:false,
        errorPed:''
      },
      computed:{
        productosFiltrados(){
          return this.productos.filter(p=>{
            const catOk = !this.filtro.cat || p.categoria===this.filtro.cat;
            const uniOk = !this.filtro.uni || p.uni===this.filtro.uni;
            const qOk   = !this.filtro.q || (p.nombre||'').toLowerCase().includes(this.filtro.q.toLowerCase());
            return catOk && uniOk && qOk;
          });
        }
      },
      created(){
        this.cargarProductos();
        this.cargarPedidos();
      },
      methods:{
        /* ===== Productos ===== */
        cargarProductos(){
          axios.get(this.base+'/api/productos')
            .then(r=> this.productos = r.data || [])
            .catch(()=> this.errorProd='No se pudo cargar la lista de productos.');
        },
        guardar(){
          this.errorProd='';
          if(!this.form.nombre || !this.form.precio){ this.errorProd='CompletÃ¡ nombre y precio.'; return; }
          this.enviandoProd=true;

          const data = {
            nombre:this.form.nombre, precio:Number(this.form.precio)||0,
            categoria:this.form.categoria, uni:this.form.uni
          };

          const req = this.form.id
            ? axios.put(this.base+'/api/productos/'+this.form.id, data)
            : axios.post(this.base+'/api/productos', data);

          req.then(()=>{ this.cancelarEdicion(); this.cargarProductos(); })
             .catch(()=> this.errorProd='No se pudo guardar el producto.')
             .then(()=> this.enviandoProd=false);
        },
        editar(p){
          this.form = { id:p.id, nombre:p.nombre, precio:p.precio, categoria:p.categoria, uni:p.uni||'ucema' };
          window.scrollTo({top:0, behavior:'smooth'});
        },
        borrar(p){
          if(!confirm('Â¿Eliminar "'+p.nombre+'"?')) return;
          this.enviandoProd=true;
          axios.delete(this.base+'/api/productos/'+p.id)
            .then(()=> this.cargarProductos())
            .catch(()=> this.errorProd='No se pudo borrar el producto.')
            .then(()=> this.enviandoProd=false);
        },
        cancelarEdicion(){
          this.form = { id:'', nombre:'', precio:'', categoria:'comida', uni:'ucema' };
          this.errorProd='';
        },

        /* ===== Pedidos ===== */
        cargarPedidos(){
          this.errorPed=''; this.cargandoPed=true;
          const q = [];
          if(this.filtroPed.estado) q.push('estado='+encodeURIComponent(this.filtroPed.estado));
          if(this.filtroPed.desde)  q.push('desde='+encodeURIComponent(this.filtroPed.desde));
          const url = this.base+'/api/pedidos' + (q.length?('?'+q.join('&')):'');
          axios.get(url)
            .then(r=> this.pedidos = r.data || [])
            .catch(()=> this.errorPed='No se pudo cargar pedidos.')
            .then(()=> this.cargandoPed=false);
        },
        setEstado(pedido, estado){
          this.cargandoPed=true; this.errorPed='';
          axios.put(this.base+'/api/pedidos/'+pedido.id, {estado})
            .then(()=> this.cargarPedidos())
            .catch(()=> this.errorPed='No se pudo actualizar el estado.')
            .then(()=> this.cargandoPed=false);
        },
        setPago(pedido, estado_pago){
          this.cargandoPed=true; this.errorPed='';
          axios.put(this.base+'/api/pedidos/'+pedido.id, {estado_pago})
            .then(()=> this.cargarPedidos())
            .catch(()=> this.errorPed='No se pudo actualizar el pago.')
            .then(()=> this.cargandoPed=false);
        }
      }
    });
  </script>
</body>
</html>
